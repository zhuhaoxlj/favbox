# Gemini API 代理配置指南

## 问题说明

如果您看到 `httpx.ConnectError` 错误，说明无法直接连接到 Google 的 Gemini API。这通常发生在以下情况：

- 🔒 **中国大陆** - Google 服务被限制
- 🏢 **公司网络** - 防火墙阻止访问
- 🌐 **某些地区** - 网络限制

---

## ✅ 解决方案：配置代理

### 方案 1: 使用现有代理（推荐）

如果您有代理服务器（如 Clash、V2Ray 等）：

#### 步骤 1: 找到代理地址

常见代理地址：
- Clash: `http://127.0.0.1:7890`
- V2Ray: `http://127.0.0.1:10808`
- 其他: 查看您的代理软件设置

#### 步骤 2: 配置环境变量

编辑 `backend/.env` 文件：

```bash
# 添加代理配置（取消注释并修改为您的代理地址）
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=http://127.0.0.1:7890
```

#### 步骤 3: 重启服务

```bash
# 停止当前服务（按 Ctrl+C）
# 重新启动
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### 步骤 4: 验证连接

访问：http://localhost:8000/api/ai/test-api-key

预期返回：
```json
{
  "status": "success",
  "message": "API Key is valid",
  "model": "gemini-3-pro-preview..."
}
```

---

### 方案 2: 使用免费代理（临时方案）

⚠️ **警告**: 免费代理不稳定且不安全，仅用于测试！

#### 步骤 1: 获取免费代理

访问免费代理网站（如 FreeProxyList）获取 HTTP 代理地址。

#### 步骤 2: 配置

编辑 `backend/.env`：

```bash
HTTP_PROXY=http://代理IP:端口
HTTPS_PROXY=http://代理IP:端口
```

---

### 方案 3: 使用国内替代API（无需代理）

如果您不想使用代理，可以考虑：

1. **SiliconFlow** - 国内可访问的兼容 API
2. **其他国产 AI** - 百度文心、阿里通义等

---

## 🔧 常见代理软件配置

### Clash

1. 打开 Clash
2. 查看"设置" → "端口设置"
3. HTTP 代理端口通常是 `7890`
4. 配置：
   ```bash
   HTTP_PROXY=http://127.0.0.1:7890
   HTTPS_PROXY=http://127.0.0.1:7890
   ```

### V2Ray

1. 打开 V2Ray
2. 查看"参数设置" → "本地监听端口"
3. 通常是 `10808` 或 `10809`
4. 配置：
   ```bash
   HTTP_PROXY=http://127.0.0.1:10808
   HTTPS_PROXY=http://127.0.0.1:10808
   ```

### 系统代理

如果您已设置系统代理，代码会自动读取环境变量：
```bash
export http_proxy=http://127.0.0.1:7890
export https_proxy=http://127.0.0.1:7890
```

---

## 🧪 测试代理

### 方法 1: 使用 curl 测试

```bash
# 设置代理
export https_proxy=http://127.0.0.1:7890

# 测试连接
curl -I https://generativelanguage.googleapis.com
```

预期返回：
```
HTTP/1.1 200 OK
```

### 方法 2: 使用 API 测试

```bash
# 通过后端测试
curl http://localhost:8000/api/ai/test-api-key
```

---

## ❌ 如果仍然无法连接

### 检查清单

- [ ] 代理软件正在运行
- [ ] 代理地址和端口正确
- [ ] 代理允许局域网连接（开启"允许来自局域网的连接"）
- [ ] 防火墙没有阻止端口
- [ ] `.env` 文件中的代理配置已取消注释

### 临时解决方案

如果实在无法连接，可以：
1. 跳过 AI 打标签功能（使用手动标签）
2. 迁移到支持后继续使用
3. 等待网络环境改善

---

## 💡 最佳实践

1. **生产环境**: 使用稳定的付费代理服务
2. **安全**: 不要在代码中硬编码代理地址
3. **测试**: 先用小批量测试代理是否可用
4. **监控**: 监控代理连接状态，失败时及时切换

---

## 📞 需要帮助？

如果以上方案都无法解决问题，请提供：
1. 您的网络环境（国内/国外/公司网络）
2. 代理软件类型和版本
3. 完整的错误信息

我会协助您进一步排查！🔧
